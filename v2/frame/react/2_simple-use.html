

<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <title>Hello World - mallow</title>
  <meta charset="utf-8">
  <meta name="description" content="mallow's blog.">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Hello World — mallow">
  <meta property="og:description" content="mallow's blog.">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120215204-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-120215204-1');
  </script>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="icon" href="/images/logo.png" type="image/png">
  <!-- main page styles -->
  <link rel="stylesheet" href="/css/page.css">
  <!-- import vue from there so that you can use vue in markdown -->
  <script src="/js/vue.min.js"></script>
  <script>window.PAGE_TYPE = "react"</script>
</head>
<body class="docs">
  <div id="mobile-bar">
    <a class="menu-button"></a>
    <a class="logo" href="/"></a>
  </div>
  <div id="header">
  <a id="logo" href="/">
    <img src="/images/logo.png">
    <span>Mallow</span>
  </a>
  <ul id="nav">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>

<!-- v3 directory -->
<!-- <li class="nav-dropdown-container learn">
  <a href="/v3/client/index.html" class="nav-link">客户端</a>
</li>

<li class="nav-dropdown-container learn">
  <a href="/v3/http/index.html" class="nav-link">HTTP</a>
</li>

<li class="nav-dropdown-container learn">
  <a href="/v3/server/index.html" class="nav-link">服务端</a>
</li>
 -->

<!-- v2 directory -->
<li class="nav-dropdown-container learn">
  <a class="nav-link">理论</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/theory/dataStructure/1_intro.html" class="nav-link">数据结构</a></li>
    <li><a href="/v2/theory/computerNet/1_intro.html" class="nav-link">计算机网络</a></li>
    <li><a href="/v2/theory/computerContain/1_intro.html" class="nav-link">计算机组成原理</a></li>
    <li><a href="/v2/theory/arithmeticV2/1_intro.html" class="nav-link">算法</a></li>
    <li><a href="/v2/theory/compile/1_intro.html" class="nav-link">编译原理</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">基础</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/basic/frontend/1_intro.html" class="nav-link">前端</a></li>
    <li><a href="/v2/basic/http/1_intro.html" class="nav-link">http</a></li>
    <li><a href="/v2/basic/backend/1_intro.html" class="nav-link">后端</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">框架</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/frame/react/1_intro.html" class="nav-link">React相关</a></li>
    <li><a href="/v2/theory/vue/1_intro.html" class="nav-link">Vue相关</a></li>
    <li><a href="/v2/theory/lodash/1_intro.html" class="nav-link">Lodash</a></li>
    <li><a href="/v2/theory/axios/1_intro.html" class="nav-link">axios</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
    <a class="nav-link">开发</a><span class="arrow"></span>
    <ul class="nav-dropdown">
      <li><a href="/v2/dev/ide/1_intro.html" class="nav-link">IDE</a></li>
      <li><a href="/v2/dev/codeManage/1_intro.html" class="nav-link">代码管理</a></li>
      <li><a href="/v2/dev/packTools/1_intro.html" class="nav-link">打包工具</a></li>
      <li><a href="/v2/dev/staging/1_intro.html" class="nav-link">脚手架</a></li>
      <li><a href="/v2/dev/debug/1_intro.html" class="nav-link">debug</a></li>
      <li><a href="/v2/dev/unitTest/1_intro.html" class="nav-link">单元测试</a></li>
      <li><a href="/v2/dev/deploy/1_intro.html" class="nav-link">构建和部署</a></li>
      <li><a href="/v2/dev/serverOprate/1_intro.html" class="nav-link">服务器操作</a></li>
    </ul>
  </li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">运行</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/runtime/browser/1_intro.html" class="nav-link">浏览器</a></li>
    <li><a href="/v2/runtime/app/1_intro.html" class="nav-link">app</a></li>
    <li><a href="/v2/runtime/desktop/1_intro.html" class="nav-link">桌面</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">监控</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/monitor/browser/1_intro.html" class="nav-link">浏览器</a></li>
    <li><a href="/v2/monitor/app/1_intro.html" class="nav-link">app</a></li>
    <li><a href="/v2/monitor/desktop/1_intro.html" class="nav-link">桌面</a></li>
  </ul>
</li>
<!-- <li class="nav-dropdown-container learn">
	<a class="nav-link">v2</a><span class="arrow"></span>
  <ul class="nav-dropdown">
		<li><h4>理论</h4></li>
		<li><ul>
			<li><a href="/v2/theory/dataStructure/1_intro.html" class="nav-link">数据结构</a></li>
			<li><a href="/v2/theory/computerNet/1_intro.html" class="nav-link">计算机网络</a></li>
			<li><a href="/v2/theory/computerContain/1_intro.html" class="nav-link">计算机组成原理</a></li>
			<li><a href="/v2/theory/arithmeticV2/1_intro.html" class="nav-link">算法</a></li>
			<li><a href="/v2/theory/compile/1_intro.html" class="nav-link">编译原理</a></li>
		</ul></li>
		<li><h4>基础</h4></li>
    <li><ul>
			<li><a href="/v2/basic/frontend/1_intro.html" class="nav-link">前端</a></li>
			<li><a href="/v2/basic/http/1_intro.html" class="nav-link">http</a></li>
			<li><a href="/v2/basic/backend/1_intro.html" class="nav-link">后端</a></li>
		</ul></li>
		<li><h4>框架&工具</h4></li>
		<li><ul>
			<li><a href="/v2/frame/react/1_intro.html" class="nav-link">React相关</a></li>
			<li><a href="/v2/theory/vue/1_intro.html" class="nav-link">Vue相关</a></li>
			<li><a href="/v2/theory/lodash/1_intro.html" class="nav-link">Lodash</a></li>
			<li><a href="/v2/theory/axios/1_intro.html" class="nav-link">axios</a></li>
		</ul></li>
		<li><h4>开发环境</h4></li>
		<li><ul>
			<li><a href="/v2/dev/ide/1_intro.html" class="nav-link">IDE</a></li>
			<li><a href="/v2/dev/codeManage/1_intro.html" class="nav-link">代码管理</a></li>
			<li><a href="/v2/dev/packTools/1_intro.html" class="nav-link">打包工具</a></li>
			<li><a href="/v2/dev/staging/1_intro.html" class="nav-link">脚手架</a></li>
			<li><a href="/v2/dev/debug/1_intro.html" class="nav-link">debug</a></li>
			<li><a href="/v2/dev/unitTest/1_intro.html" class="nav-link">单元测试</a></li>
			<li><a href="/v2/dev/deploy/1_intro.html" class="nav-link">构建和部署</a></li>
			<li><a href="/v2/dev/serverOprate/1_intro.html" class="nav-link">服务器操作</a></li>
		</ul></li>
		<li><h4>运行环境</h4></li>
		<li><ul>
			<li><a href="/v2/runtime/browser/1_intro.html" class="nav-link">浏览器</a></li>
			<li><a href="/v2/runtime/app/1_intro.html" class="nav-link">app</a></li>
			<li><a href="/v2/runtime/desktop/1_intro.html" class="nav-link">桌面</a></li>
		</ul></li>
		<li><h4>监控&分析</h4></li>
		<li><ul>
			<li><a href="/v2/monitor/browser/1_intro.html" class="nav-link">浏览器</a></li>
			<li><a href="/v2/monitor/app/1_intro.html" class="nav-link">app</a></li>
			<li><a href="/v2/monitor/desktop/1_intro.html" class="nav-link">桌面</a></li>
		</ul></li>
		<li class="nav-dropdown-container learn">
			<a href="/special/1_原型.html" class="nav-link">专题</a>
		</li>			
  </ul>
</li>
 -->

<!-- v1 directory -->
<li class="nav-dropdown-container learn">
  <a class="nav-link">v1</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>软件工程化</h4></li>
    <li><ul>
      <li><a href="/software/engineering.html" class="nav-link">概念&实践</a></li>
    </ul></li>
    <li><h4>前端</h4></li>
    <li><ul>
      <li><a href="/frontend/skeleton/1_skeleton.html" class="nav-link">skeleton</a></li>
      <li><a href="/frontend/html/1_define.html" class="nav-link">html</a></li>
      <li><a href="/frontend/css/1_define.html" class="nav-link">css</a></li>
      <li><a href="/frontend/js/1_enter&going.html" class="nav-link">javascript</a></li>
      <li><a href="/frontend/framework/1_vue.html" class="nav-link">framework</a></li>
      <li><a href="/frontend/browser/1_safe.html" class="nav-link">browser</a></li>
      <li><a href="/frontend/important/1_conclude.html" class="nav-link">conclude</a></li>
    </ul></li>
    <li><h4>后端</h4></li>
    <li><ul>
      <li><a href="/backend/node/note.html" class="nav-link">node</a></li>
      <li><a href="/backend/http/1_http.html" class="nav-link">http</a></li>
      <li><a href="/backend/java/core.html" class="nav-link">java</a></li>
      <li><a href="/backend/database/1_mysql.html" class="nav-link">database</a></li>
    </ul></li>
    <li><h4>算法</h4></li>
    <li><ul>
      <li><a href="/arithmetic/1_lintcode.html" class="nav-link">概念&实践</a></li>
    </ul></li>
    <li><h4>读书</h4></li>
    <li><ul>
      <li><a href="/books/memory/1_利玛窦的记忆宫殿.html" class="nav-link">记忆学</a></li>
      <li><a href="/books/computer/1_构建高性能web网站.html" class="nav-link">计算机</a></li>
      <li><a href="/books/history/资治通鉴/1_周纪一.html" class="nav-link">历史</a></li>
      <li><a href="/books/economics/1_国富论.html" class="nav-link">经济</a></li>
    </ul></li>
  </ul>
</li>

  </ul>
</div>
  
    <div id="main" class="fix-sidebar">
        <div class="guide-links">
  
  
  
  
    <span style="float: right; margin-right: 30px;">← <a style="color: goldenrod;" href="/v2/frame/react/1_intro.html">介绍</a></span>
  
</div>

  <div class="sidebar">
  <div class="sidebar-inner">
    <h3>当前位置：react</h3>
    <div class="list">
      <ul class="menu-root">
  
    
      <li>
        <a href="/v2/frame/react/1_intro.html" class="sidebar-link">
          介绍
        </a>
      </li>
      
    
      <li>
        <a href="/v2/frame/react/2_simple-use.html" class="sidebar-link current">
          Hello World
        </a>
      </li>
      
</ul>
    </div>
    <h3>浏览其它</h3>
    <ul class="main-menu">
      <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>

<!-- v3 directory -->
<!-- <li class="nav-dropdown-container learn">
  <a href="/v3/client/index.html" class="nav-link">客户端</a>
</li>

<li class="nav-dropdown-container learn">
  <a href="/v3/http/index.html" class="nav-link">HTTP</a>
</li>

<li class="nav-dropdown-container learn">
  <a href="/v3/server/index.html" class="nav-link">服务端</a>
</li>
 -->

<!-- v2 directory -->
<li class="nav-dropdown-container learn">
  <a class="nav-link">理论</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/theory/dataStructure/1_intro.html" class="nav-link">数据结构</a></li>
    <li><a href="/v2/theory/computerNet/1_intro.html" class="nav-link">计算机网络</a></li>
    <li><a href="/v2/theory/computerContain/1_intro.html" class="nav-link">计算机组成原理</a></li>
    <li><a href="/v2/theory/arithmeticV2/1_intro.html" class="nav-link">算法</a></li>
    <li><a href="/v2/theory/compile/1_intro.html" class="nav-link">编译原理</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">基础</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/basic/frontend/1_intro.html" class="nav-link">前端</a></li>
    <li><a href="/v2/basic/http/1_intro.html" class="nav-link">http</a></li>
    <li><a href="/v2/basic/backend/1_intro.html" class="nav-link">后端</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">框架</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/frame/react/1_intro.html" class="nav-link">React相关</a></li>
    <li><a href="/v2/theory/vue/1_intro.html" class="nav-link">Vue相关</a></li>
    <li><a href="/v2/theory/lodash/1_intro.html" class="nav-link">Lodash</a></li>
    <li><a href="/v2/theory/axios/1_intro.html" class="nav-link">axios</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
    <a class="nav-link">开发</a><span class="arrow"></span>
    <ul class="nav-dropdown">
      <li><a href="/v2/dev/ide/1_intro.html" class="nav-link">IDE</a></li>
      <li><a href="/v2/dev/codeManage/1_intro.html" class="nav-link">代码管理</a></li>
      <li><a href="/v2/dev/packTools/1_intro.html" class="nav-link">打包工具</a></li>
      <li><a href="/v2/dev/staging/1_intro.html" class="nav-link">脚手架</a></li>
      <li><a href="/v2/dev/debug/1_intro.html" class="nav-link">debug</a></li>
      <li><a href="/v2/dev/unitTest/1_intro.html" class="nav-link">单元测试</a></li>
      <li><a href="/v2/dev/deploy/1_intro.html" class="nav-link">构建和部署</a></li>
      <li><a href="/v2/dev/serverOprate/1_intro.html" class="nav-link">服务器操作</a></li>
    </ul>
  </li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">运行</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/runtime/browser/1_intro.html" class="nav-link">浏览器</a></li>
    <li><a href="/v2/runtime/app/1_intro.html" class="nav-link">app</a></li>
    <li><a href="/v2/runtime/desktop/1_intro.html" class="nav-link">桌面</a></li>
  </ul>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">监控</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/v2/monitor/browser/1_intro.html" class="nav-link">浏览器</a></li>
    <li><a href="/v2/monitor/app/1_intro.html" class="nav-link">app</a></li>
    <li><a href="/v2/monitor/desktop/1_intro.html" class="nav-link">桌面</a></li>
  </ul>
</li>
<!-- <li class="nav-dropdown-container learn">
	<a class="nav-link">v2</a><span class="arrow"></span>
  <ul class="nav-dropdown">
		<li><h4>理论</h4></li>
		<li><ul>
			<li><a href="/v2/theory/dataStructure/1_intro.html" class="nav-link">数据结构</a></li>
			<li><a href="/v2/theory/computerNet/1_intro.html" class="nav-link">计算机网络</a></li>
			<li><a href="/v2/theory/computerContain/1_intro.html" class="nav-link">计算机组成原理</a></li>
			<li><a href="/v2/theory/arithmeticV2/1_intro.html" class="nav-link">算法</a></li>
			<li><a href="/v2/theory/compile/1_intro.html" class="nav-link">编译原理</a></li>
		</ul></li>
		<li><h4>基础</h4></li>
    <li><ul>
			<li><a href="/v2/basic/frontend/1_intro.html" class="nav-link">前端</a></li>
			<li><a href="/v2/basic/http/1_intro.html" class="nav-link">http</a></li>
			<li><a href="/v2/basic/backend/1_intro.html" class="nav-link">后端</a></li>
		</ul></li>
		<li><h4>框架&工具</h4></li>
		<li><ul>
			<li><a href="/v2/frame/react/1_intro.html" class="nav-link">React相关</a></li>
			<li><a href="/v2/theory/vue/1_intro.html" class="nav-link">Vue相关</a></li>
			<li><a href="/v2/theory/lodash/1_intro.html" class="nav-link">Lodash</a></li>
			<li><a href="/v2/theory/axios/1_intro.html" class="nav-link">axios</a></li>
		</ul></li>
		<li><h4>开发环境</h4></li>
		<li><ul>
			<li><a href="/v2/dev/ide/1_intro.html" class="nav-link">IDE</a></li>
			<li><a href="/v2/dev/codeManage/1_intro.html" class="nav-link">代码管理</a></li>
			<li><a href="/v2/dev/packTools/1_intro.html" class="nav-link">打包工具</a></li>
			<li><a href="/v2/dev/staging/1_intro.html" class="nav-link">脚手架</a></li>
			<li><a href="/v2/dev/debug/1_intro.html" class="nav-link">debug</a></li>
			<li><a href="/v2/dev/unitTest/1_intro.html" class="nav-link">单元测试</a></li>
			<li><a href="/v2/dev/deploy/1_intro.html" class="nav-link">构建和部署</a></li>
			<li><a href="/v2/dev/serverOprate/1_intro.html" class="nav-link">服务器操作</a></li>
		</ul></li>
		<li><h4>运行环境</h4></li>
		<li><ul>
			<li><a href="/v2/runtime/browser/1_intro.html" class="nav-link">浏览器</a></li>
			<li><a href="/v2/runtime/app/1_intro.html" class="nav-link">app</a></li>
			<li><a href="/v2/runtime/desktop/1_intro.html" class="nav-link">桌面</a></li>
		</ul></li>
		<li><h4>监控&分析</h4></li>
		<li><ul>
			<li><a href="/v2/monitor/browser/1_intro.html" class="nav-link">浏览器</a></li>
			<li><a href="/v2/monitor/app/1_intro.html" class="nav-link">app</a></li>
			<li><a href="/v2/monitor/desktop/1_intro.html" class="nav-link">桌面</a></li>
		</ul></li>
		<li class="nav-dropdown-container learn">
			<a href="/special/1_原型.html" class="nav-link">专题</a>
		</li>			
  </ul>
</li>
 -->

<!-- v1 directory -->
<li class="nav-dropdown-container learn">
  <a class="nav-link">v1</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>软件工程化</h4></li>
    <li><ul>
      <li><a href="/software/engineering.html" class="nav-link">概念&实践</a></li>
    </ul></li>
    <li><h4>前端</h4></li>
    <li><ul>
      <li><a href="/frontend/skeleton/1_skeleton.html" class="nav-link">skeleton</a></li>
      <li><a href="/frontend/html/1_define.html" class="nav-link">html</a></li>
      <li><a href="/frontend/css/1_define.html" class="nav-link">css</a></li>
      <li><a href="/frontend/js/1_enter&going.html" class="nav-link">javascript</a></li>
      <li><a href="/frontend/framework/1_vue.html" class="nav-link">framework</a></li>
      <li><a href="/frontend/browser/1_safe.html" class="nav-link">browser</a></li>
      <li><a href="/frontend/important/1_conclude.html" class="nav-link">conclude</a></li>
    </ul></li>
    <li><h4>后端</h4></li>
    <li><ul>
      <li><a href="/backend/node/note.html" class="nav-link">node</a></li>
      <li><a href="/backend/http/1_http.html" class="nav-link">http</a></li>
      <li><a href="/backend/java/core.html" class="nav-link">java</a></li>
      <li><a href="/backend/database/1_mysql.html" class="nav-link">database</a></li>
    </ul></li>
    <li><h4>算法</h4></li>
    <li><ul>
      <li><a href="/arithmetic/1_lintcode.html" class="nav-link">概念&实践</a></li>
    </ul></li>
    <li><h4>读书</h4></li>
    <li><ul>
      <li><a href="/books/memory/1_利玛窦的记忆宫殿.html" class="nav-link">记忆学</a></li>
      <li><a href="/books/computer/1_构建高性能web网站.html" class="nav-link">计算机</a></li>
      <li><a href="/books/history/资治通鉴/1_周纪一.html" class="nav-link">历史</a></li>
      <li><a href="/books/economics/1_国富论.html" class="nav-link">经济</a></li>
    </ul></li>
  </ul>
</li>

    </ul>
  </div>
</div>


<div class="content react with-sidebar ">
  <ul class="menu-root">
  
</ul>
  
    <h1>Hello World</h1>
  
  <blockquote>
<p>下面的示例都是基于webpack的</p>
</blockquote>
<p><strong>学习一个框架先从最简单的示例做起，比如下面的示例：</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line">render(</span><br><span class="line">  &lt;h1&gt;Hello World&lt;<span class="regexp">/h1&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root')</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>

<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><ol>
<li><p>如果我们使用<code>webpack</code>来开发<code>react</code>应用，如何需要使用<code>JSX</code>，我们需要引入以下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果你引入了这段代码，<code>babel</code>会自动将<code>JSX</code>解析成如下形式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">React.createElement(</span><br><span class="line">	<span class="string">'h1'</span>,</span><br><span class="line">	<span class="literal">null</span>, <span class="comment">// 这个参数代表JSX的props</span></span><br><span class="line">	<span class="string">'Hello, world'</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>所以说需要导入<code>React</code>来支持<code>JSX</code>的解析。</p>
</li>
<li><p>具体<code>babel</code>是怎么编译的，查看这个<a href="https://babeljs.io/repl#?babili=false&browsers=&build=&builtIns=false&spec=false&loose=false&code_lz=JYWwDg9gTgLgBAJQKYEMDG8BmUIjgcilQ3wG4AoctCAOwGd4U4BeOAHgAsBGAPhiQZsA9Nx5A&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=es2015%2Creact%2Cstage-2&prettier=false&targets=&version=7.5.5&externalPlugins=" target="_blank" rel="noopener">在线演示</a></p>
</li>
</ol>
<h2 id="研究重点"><a href="#研究重点" class="headerlink" title="研究重点"></a>研究重点</h2><p><strong>至此，我们发现两个需要研究的重点</strong></p>
<ol>
<li>第一个是<code>react-dom</code>中的<code>render</code>方法。</li>
<li>第二个是<code>react</code>中的<code>createElement</code>方法。</li>
</ol>
<p>下面我们来一个个看：</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>先<code>clone</code>一下<code>react</code>的仓库。</li>
<li>源码是使用<code>flow</code>写的，最好<code>build</code>一下，拿最后生成的<code>es5</code>文件来研究源码，<code>flow</code>版本有一些<code>webpack</code>的变量和参数，很难找，不清晰，而且依赖引用太多，跳跃性太强。</li>
</ol>
<h2 id="react-createElement"><a href="#react-createElement" class="headerlink" title="react/createElement"></a>react/createElement</h2><ol>
<li><p>我们只看这个示例执行的时候<code>createElement</code>跑过的分支，整理如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElementWithValidation</span>(<span class="params">type, props, children</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> info = <span class="string">''</span>;</span><br><span class="line">	info += getDeclarationErrorAddendum();</span><br><span class="line">	<span class="keyword">var</span> typeString = <span class="keyword">typeof</span> type;</span><br><span class="line">  <span class="keyword">return</span> createElement.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>createElement</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> propName; <span class="comment">// Reserved names are extracted</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> props = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> key = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> ref = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> source = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasValidRef(config)) &#123;</span><br><span class="line">      ref = config.ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasValidKey(config)) &#123;</span><br><span class="line">      key = <span class="string">''</span> + config.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self = config.__self === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__self;</span><br><span class="line">    source = config.__source === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.__source; <span class="comment">// Remaining properties are added to a new props object</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> config) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hasOwnProperty.call(config, propName) &amp;&amp; !RESERVED_PROPS.hasOwnProperty(propName)) &#123;</span><br><span class="line">        props[propName] = config[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="comment">// Children can be more than one argument, and those are transferred onto</span></span><br><span class="line">  <span class="comment">// the newly allocated props object.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> childrenLength = <span class="built_in">arguments</span>.length - <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (childrenLength === <span class="number">1</span>) &#123;</span><br><span class="line">    props.children = children;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childrenLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> childArray = <span class="built_in">Array</span>(childrenLength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      childArray[i] = <span class="built_in">arguments</span>[i + <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Object</span>.freeze) &#123;</span><br><span class="line">        <span class="built_in">Object</span>.freeze(childArray);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    props.children = childArray;</span><br><span class="line">  &#125; <span class="comment">// Resolve default props</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type &amp;&amp; type.defaultProps) &#123;</span><br><span class="line">    <span class="keyword">var</span> defaultProps = type.defaultProps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (propName <span class="keyword">in</span> defaultProps) &#123;</span><br><span class="line">      <span class="keyword">if</span> (props[propName] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        props[propName] = defaultProps[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (key || ref) &#123;</span><br><span class="line">      <span class="keyword">var</span> displayName = <span class="keyword">typeof</span> type === <span class="string">'function'</span> ? type.displayName || type.name || <span class="string">'Unknown'</span> : type;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (key) &#123;</span><br><span class="line">        defineKeyPropWarningGetter(props, displayName);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (ref) &#123;</span><br><span class="line">        defineRefPropWarningGetter(props, displayName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ReactElement(type, key, ref, self, source, ReactCurrentOwner.current, props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li><p>很简单，最后会返回这样的执行函数，我们把参数直接赛给它：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ReactElement(</span><br><span class="line">	<span class="string">'h1'</span>, <span class="comment">// type</span></span><br><span class="line">	<span class="literal">null</span>, <span class="comment">// key</span></span><br><span class="line">	<span class="literal">null</span>, <span class="comment">// ref</span></span><br><span class="line">	<span class="literal">null</span>, <span class="comment">// self</span></span><br><span class="line">	<span class="literal">null</span>, <span class="comment">// source</span></span><br><span class="line">	Fiber, <span class="comment">// Fiber结构，目前应该用不到，暂时不详细说</span></span><br><span class="line">	&#123;<span class="attr">children</span>: <span class="string">'Hello world'</span>&#125; <span class="comment">// 因为只有一个孩子，所以比较简单</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>ok，接下来我们来看看<code>ReactElement</code>这个方法。</p>
</li>
</ol>
<h3 id="ReactElement"><a href="#ReactElement" class="headerlink" title="ReactElement"></a>ReactElement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasSymbol = <span class="keyword">typeof</span> <span class="built_in">Symbol</span> === <span class="string">'function'</span> &amp;&amp; <span class="built_in">Symbol</span>.for;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> REACT_ELEMENT_TYPE = hasSymbol</span><br><span class="line">  ? <span class="built_in">Symbol</span>.for(<span class="string">'react.element'</span>)</span><br><span class="line">  : <span class="number">0xeac7</span>;</span><br><span class="line"><span class="keyword">const</span> ReactElement = <span class="function"><span class="keyword">function</span>(<span class="params">type, key, ref, self, source, owner, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// This tag allows us to uniquely identify this as a React Element</span></span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">    type: type,</span><br><span class="line">    key: key,</span><br><span class="line">    ref: ref,</span><br><span class="line">    props: props,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">    _owner: owner,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个函数会返回一个<code>element</code>，下面我们来看下<code>element</code>的结构。</p>
<h3 id="element"><a href="#element" class="headerlink" title="element"></a>element</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">	$$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>.for(<span class="string">'react.element'</span>),</span><br><span class="line">	type: <span class="string">'h1'</span>,</span><br><span class="line">	key: <span class="literal">null</span>,</span><br><span class="line">	ref: <span class="literal">null</span>,</span><br><span class="line">	props: &#123;<span class="attr">children</span>: <span class="string">'Hello world'</span>&#125;,</span><br><span class="line">	_owner: Fiber,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，我们知道了最后的结果，是一个含有一些属性的对象，接下来我们看看<code>react-dom</code>中的<code>render</code>方法是怎么处理这个对象的</p>
<h2 id="react-dom：render"><a href="#react-dom：render" class="headerlink" title="react-dom：render"></a>react-dom：render</h2><h3 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;h1&gt;Hello, world&lt;<span class="regexp">/h1&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root')</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>

<p>现在我们知道其实最后执行的代码是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render(</span><br><span class="line">  &#123;</span><br><span class="line">		$$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>.for(<span class="string">'react.element'</span>),</span><br><span class="line">		type: <span class="string">'h1'</span>,</span><br><span class="line">		key: <span class="literal">null</span>,</span><br><span class="line">		ref: <span class="literal">null</span>,</span><br><span class="line">		props: &#123;<span class="attr">children</span>: <span class="string">'Hello world'</span>&#125;,</span><br><span class="line">		_owner: Fiber,</span><br><span class="line">	&#125;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><ol>
<li><p>老办法，找到<code>react-dom</code>的入口文件<code>react-dom/index.js</code>，我们可以看到它<code>export</code>出来的是<code>./src/client/ReactDOM</code>。</p>
</li>
<li><p>我们去<code>./src/client/ReactDOM</code>找到<code>render</code>方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactDOM = &#123;</span><br><span class="line">	...</span><br><span class="line">	render,</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>整理一下<code>render</code>方法，提取出我们示例跑过的分支：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">render(</span><br><span class="line">    element: React$Element&lt;any&gt;,</span><br><span class="line">    container: DOMContainer,</span><br><span class="line">    callback: ?<span class="built_in">Function</span>,</span><br><span class="line">  ) &#123;</span><br><span class="line">	<span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">		<span class="literal">null</span>,</span><br><span class="line">		element,</span><br><span class="line">		container,</span><br><span class="line">		<span class="literal">false</span>,</span><br><span class="line">		callback,</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看出我们最终执行的是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">	<span class="literal">null</span>,</span><br><span class="line">	&#123;</span><br><span class="line">		$$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>.for(<span class="string">'react.element'</span>),</span><br><span class="line">		type: <span class="string">'h1'</span>,</span><br><span class="line">		key: <span class="literal">null</span>,</span><br><span class="line">		ref: <span class="literal">null</span>,</span><br><span class="line">		props: &#123;<span class="attr">children</span>: <span class="string">'Hello world'</span>&#125;,</span><br><span class="line">		_owner: Fiber,</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="built_in">document</span>.getElementById(<span class="string">'root'</span>),</span><br><span class="line">	<span class="literal">false</span>,</span><br><span class="line">	<span class="literal">undefined</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面我们来看看<code>legacyRenderSubtreeIntoContainer</code>这个方法：</p>
</li>
</ol>
<h3 id="legacyRenderSubtreeIntoContainer"><a href="#legacyRenderSubtreeIntoContainer" class="headerlink" title="legacyRenderSubtreeIntoContainer"></a>legacyRenderSubtreeIntoContainer</h3><ol>
<li><p>整理出我们的示例跑过的分支：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="regexp">//</span> null</span></span></span><br><span class="line"><span class="function"><span class="params">	parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="regexp">//</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="regexp">//</span> 	$$typeof: Symbol.for(<span class="string">'react.element'</span></span>),</span></span><br><span class="line"><span class="function">	// 	<span class="title">type</span>: '<span class="title">h1</span>',</span></span><br><span class="line"><span class="function">	// 	<span class="title">key</span>: <span class="title">null</span>,</span></span><br><span class="line"><span class="function">	// 	<span class="title">ref</span>: <span class="title">null</span>,</span></span><br><span class="line"><span class="function">	// 	<span class="title">props</span>: </span>&#123;children: <span class="string">'Hello world'</span>&#125;,</span><br><span class="line">	<span class="comment">// 	_owner: Fiber,</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	children: ReactNodeList,</span><br><span class="line">	<span class="comment">// document.getElementById('root')</span></span><br><span class="line">	container: DOMContainer,</span><br><span class="line">	<span class="comment">// false</span></span><br><span class="line">	forceHydrate: boolean,</span><br><span class="line">	<span class="comment">// undefined</span></span><br><span class="line">  callback: ?<span class="built_in">Function</span>,</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Without `any` type, Flow says "Property cannot be accessed on any</span></span><br><span class="line">  <span class="comment">// member of intersection type." Whyyyyyy.</span></span><br><span class="line">  <span class="keyword">let</span> root: _ReactSyncRoot = (container._reactRootContainer: any);</span><br><span class="line">  <span class="keyword">let</span> fiberRoot;</span><br><span class="line">  <span class="comment">// Initial mount</span></span><br><span class="line">	root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">		container,</span><br><span class="line">		forceHydrate,</span><br><span class="line">	);</span><br><span class="line">	fiberRoot = root._internalRoot;</span><br><span class="line">	<span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">	unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">	&#125;);</span><br><span class="line">  <span class="keyword">return</span> getPublicRootInstance(fiberRoot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们来拆分一下：</p>
<ol>
<li><code>root</code>: 首先会检查一下<code>container._reactRootContainer</code>存不存在，如果不存在，就执行<code>root = container._reactRootContainer = legacyCreateRootFromDOMContainer(container, forceHydrate)</code>，执行完这个之后注意一下，我们的<code>container</code>就会有<code>_reactRootContainer</code>这个属性了。</li>
<li><code>fiberRoot</code>就是<code>legacyCreateRootFromDOMContainer(container, forceHydrate)._internalRoot</code>，这样看起来更直观。</li>
</ol>
</li>
<li><p>所以有四个函数我们需要研究一下：<code>legacyCreateRootFromDOMContainer</code>、<code>updateContainer</code>、<code>unbatchedUpdates</code>、<code>getPublicRootInstance</code>。</p>
</li>
<li><p>我们一个个看下：</p>
</li>
</ol>
<h3 id="legacyCreateRootFromDOMContainer"><a href="#legacyCreateRootFromDOMContainer" class="headerlink" title="legacyCreateRootFromDOMContainer"></a>legacyCreateRootFromDOMContainer</h3><ol>
<li><p>也就是执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">legacyCreateRootFromDOMContainer(</span><br><span class="line">	<span class="built_in">document</span>.getElementById(<span class="string">'root'</span>),</span><br><span class="line">	<span class="literal">false</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>整理如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyCreateRootFromDOMContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">_ReactSyncRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> shouldHydrate =</span><br><span class="line">    forceHydrate || shouldHydrateDueToLegacyHeuristic(container); <span class="comment">// 这个函数会返回false，它会检查</span></span><br><span class="line">  <span class="comment">// 清空container存在的内容，确保所有的dom结构都在掌控之中</span></span><br><span class="line">  <span class="keyword">if</span> (!shouldHydrate) &#123;</span><br><span class="line">    <span class="keyword">let</span> warned = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> rootSibling;</span><br><span class="line">    <span class="keyword">while</span> ((rootSibling = container.lastChild)) &#123;</span><br><span class="line">      container.removeChild(rootSibling);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Legacy roots are not batched.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactSyncRoot(</span><br><span class="line">    container, <span class="comment">// document.getElementById('root')</span></span><br><span class="line">    LegacyRoot, <span class="comment">// 0</span></span><br><span class="line">    shouldHydrate <span class="comment">// false</span></span><br><span class="line">      ? &#123;</span><br><span class="line">          hydrate: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="literal">undefined</span>,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看出，这个函数会返回一个<code>ReactSyncRoot</code>的示例，我们来看下这个构造函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactSyncRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: DOMContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag, <span class="regexp">//</span> <span class="number">0</span></span></span></span><br><span class="line"><span class="function"><span class="params">  options: void | RootOptions, <span class="regexp">//</span> undefined</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Tag is either LegacyRoot or Concurrent Root</span></span><br><span class="line">  <span class="keyword">const</span> hydrate = options != <span class="literal">null</span> &amp;&amp; options.hydrate === <span class="literal">true</span>; <span class="comment">// false</span></span><br><span class="line">  <span class="keyword">const</span> hydrationCallbacks =</span><br><span class="line">    (options != <span class="literal">null</span> &amp;&amp; options.hydrationOptions) || <span class="literal">null</span>; <span class="comment">// false</span></span><br><span class="line">  <span class="keyword">const</span> root = createContainer(container, tag, hydrate, hydrationCallbacks);</span><br><span class="line">  <span class="keyword">this</span>._internalRoot = root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例化之后，会产生这样的结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	_internalRoot: createContainer(container, tag, hydrate, hydrationCallbacks)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>看一下<code>createContainer</code>的执行结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag, <span class="regexp">//</span> <span class="number">0</span></span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean, <span class="regexp">//</span> false</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks, <span class="regexp">//</span> false</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">OpaqueRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createFiberRoot(containerInfo, tag, hydrate, hydrationCallbacks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>即返回一个<code>FiberRoot</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag, <span class="regexp">//</span> <span class="number">0</span></span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean, <span class="regexp">//</span> false</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks, <span class="regexp">//</span> false</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = (<span class="keyword">new</span> FiberRootNode(containerInfo, tag, hydrate): any);</span><br><span class="line">  <span class="comment">// 这段代码会产生循环引用，类似：&#123; current: &#123;stateNode: &#123; current: &#123; stateNode ... &#125; &#125; &#125; &#125;</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(tag);</span><br><span class="line">  root.current = uninitializedFiber;</span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来有两个函数需要研究一下：</p>
</li>
</ol>
<h4 id="FiberRootNode"><a href="#FiberRootNode" class="headerlink" title="FiberRootNode"></a>FiberRootNode</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberRootNode</span>(<span class="params">containerInfo, tag, hydrate</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.tag = tag;</span><br><span class="line">  <span class="keyword">this</span>.current = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.containerInfo = containerInfo;</span><br><span class="line">  <span class="keyword">this</span>.pendingChildren = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.pingCache = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.finishedExpirationTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.timeoutHandle = noTimeout;</span><br><span class="line">  <span class="keyword">this</span>.context = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.pendingContext = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.hydrate = hydrate;</span><br><span class="line">  <span class="keyword">this</span>.firstBatch = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.callbackNode = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.callbackExpirationTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.firstPendingTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.lastPendingTime = NoWork;</span><br><span class="line">	<span class="keyword">this</span>.pingTime = NoWork;</span><br><span class="line">	<span class="keyword">this</span>.interactionThreadID = unstable_getThreadID();</span><br><span class="line">	<span class="keyword">this</span>.memoizedInteractions = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">	<span class="keyword">this</span>.pendingInteractionMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个构造函数<code>(new FiberRootNode(containerInfo, tag, hydrate): any)</code>示例化之后会产生这样的结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	tag: <span class="number">0</span>,</span><br><span class="line">	current: <span class="literal">null</span>,</span><br><span class="line">	containerInfo: <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>),</span><br><span class="line">	pendingChildren: <span class="literal">null</span>,</span><br><span class="line">	finishedExpirationTime: <span class="number">0</span>,</span><br><span class="line">	finishedWork: <span class="literal">null</span>,</span><br><span class="line">	timeoutHandle: <span class="number">-1</span>, <span class="comment">// 应该就是react-reconciler/src/forks/ReactFiberHostConfig.dom.js，</span></span><br><span class="line">	context: <span class="literal">null</span>,</span><br><span class="line">	pendingContext: <span class="literal">null</span>,</span><br><span class="line">	hydrate: <span class="literal">false</span>,</span><br><span class="line">	firstBatch: <span class="literal">null</span>,</span><br><span class="line">	callbackNode: <span class="literal">null</span>,</span><br><span class="line">	callbackExpirationTime: <span class="number">0</span>,</span><br><span class="line">	firstPendingTime: <span class="number">0</span>,</span><br><span class="line">	lastPendingTime: <span class="number">0</span>,</span><br><span class="line">	pingTime: <span class="number">0</span>,</span><br><span class="line">	interactionThreadId: <span class="number">1</span>, <span class="comment">// 递增的数字</span></span><br><span class="line">	memoizedInteractions: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">	pendingInteractionMap: <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="createHostRootFiber"><a href="#createHostRootFiber" class="headerlink" title="createHostRootFiber"></a>createHostRootFiber</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params">tag: RootTag</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createFiber(<span class="number">3</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createFiber:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> createFiber = <span class="function"><span class="keyword">function</span> (<span class="params">tag, pendingProps, key, mode</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>即执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberNode</span>(<span class="params">tag, pendingProps, key, mode</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Instance</span></span><br><span class="line">  <span class="keyword">this</span>.tag = tag;</span><br><span class="line">  <span class="keyword">this</span>.key = key;</span><br><span class="line">  <span class="keyword">this</span>.elementType = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.type = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.stateNode = <span class="literal">null</span>; <span class="comment">// Fiber</span></span><br><span class="line">  <span class="keyword">this</span>.return = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.child = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.sibling = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>.ref = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.pendingProps = pendingProps;</span><br><span class="line">  <span class="keyword">this</span>.memoizedProps = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.updateQueue = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.memoizedState = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.dependencies = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.mode = mode; <span class="comment">// Effects</span></span><br><span class="line">  <span class="keyword">this</span>.effectTag = NoEffect;</span><br><span class="line">  <span class="keyword">this</span>.nextEffect = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.firstEffect = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.lastEffect = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.expirationTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.childExpirationTime = NoWork;</span><br><span class="line">  <span class="keyword">this</span>.alternate = <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">this</span>.actualDuration = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">this</span>.actualStartTime = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">this</span>.selfBaseDuration = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">this</span>.treeBaseDuration = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">this</span>._debugID = debugCounter++;</span><br><span class="line">	<span class="keyword">this</span>._debugIsCurrentlyTiming = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">this</span>._debugSource = <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">this</span>._debugOwner = <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">this</span>._debugNeedsRemount = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">this</span>._debugHookTypes = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到这样的实例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	tag: <span class="number">3</span>,</span><br><span class="line">	key: <span class="literal">null</span>,</span><br><span class="line">	elementType: <span class="literal">null</span>,</span><br><span class="line">	type: <span class="literal">null</span>,</span><br><span class="line">	stateNode: <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">return</span>: <span class="literal">null</span>,</span><br><span class="line">	child: <span class="literal">null</span>,</span><br><span class="line">	sibling: <span class="literal">null</span>,</span><br><span class="line">	index: <span class="number">0</span>,</span><br><span class="line">	ref: <span class="literal">null</span>,</span><br><span class="line">	pendingProps: <span class="literal">null</span>,</span><br><span class="line">	memoizedProps: <span class="literal">null</span>,</span><br><span class="line">	updateQueue: <span class="literal">null</span>,</span><br><span class="line">	memoizedState: <span class="literal">null</span>,</span><br><span class="line">	dependencied: <span class="literal">null</span>,</span><br><span class="line">	mode: <span class="number">0</span>,</span><br><span class="line">	effectTag: <span class="number">0</span>,</span><br><span class="line">	nextEffect: <span class="literal">null</span>,</span><br><span class="line">	firstEffect: <span class="literal">null</span>,</span><br><span class="line">	lastEffect: <span class="literal">null</span>,</span><br><span class="line">	expirationTime: <span class="number">0</span>,</span><br><span class="line">	childExpirationTime: <span class="number">0</span>,</span><br><span class="line">	alternate: <span class="literal">null</span>,</span><br><span class="line">	actualDuration: <span class="number">0</span>,</span><br><span class="line">	actualStartTime: <span class="number">-1</span>,</span><br><span class="line">	selfBaseDuration: <span class="number">0</span>,</span><br><span class="line">	treeBaseDuration: <span class="number">0</span>,</span><br><span class="line">	_debugID: <span class="number">1</span>,</span><br><span class="line">	_debugIsCurrentlyTiming: <span class="literal">false</span>,</span><br><span class="line">	_debugSource: <span class="literal">null</span>,</span><br><span class="line">	_debugOwner: <span class="literal">null</span>,</span><br><span class="line">	_debugNeedsRemount: <span class="literal">false</span>,</span><br><span class="line">	_debugHookTypes: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li><p>ok, 最后我们的<code>root</code>会产生这样的一个结构，也就是后面使用的<code>fiberRoot</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fiberRoot = &#123;</span><br><span class="line">	<span class="comment">// 由示例化FiberRootNode产生</span></span><br><span class="line">	tag: <span class="number">0</span>,</span><br><span class="line">	current: <span class="literal">null</span>,</span><br><span class="line">	containerInfo: <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>),</span><br><span class="line">	pendingChildren: <span class="literal">null</span>,</span><br><span class="line">	finishedExpirationTime: <span class="number">0</span>,</span><br><span class="line">	finishedWork: <span class="literal">null</span>,</span><br><span class="line">	timeoutHandle: <span class="number">-1</span>, <span class="comment">// 应该就是react-reconciler/src/forks/ReactFiberHostConfig.dom.js，</span></span><br><span class="line">	context: <span class="literal">null</span>,</span><br><span class="line">	pendingContext: <span class="literal">null</span>,</span><br><span class="line">	hydrate: <span class="literal">false</span>,</span><br><span class="line">	firstBatch: <span class="literal">null</span>,</span><br><span class="line">	callbackNode: <span class="literal">null</span>,</span><br><span class="line">	callbackExpirationTime: <span class="number">0</span>,</span><br><span class="line">	firstPendingTime: <span class="number">0</span>,</span><br><span class="line">	lastPendingTime: <span class="number">0</span>,</span><br><span class="line">	pingTime: <span class="number">0</span>,</span><br><span class="line">	interactionThreadId: <span class="number">1</span>, <span class="comment">// 递增的数字</span></span><br><span class="line">	memoizedInteractions: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">	pendingInteractionMap: <span class="keyword">new</span> <span class="built_in">Map</span>(),</span><br><span class="line"></span><br><span class="line">	current: &#123;</span><br><span class="line">		tag: <span class="number">3</span>,</span><br><span class="line">		key: <span class="literal">null</span>,</span><br><span class="line">		elementType: <span class="literal">null</span>,</span><br><span class="line">		type: <span class="literal">null</span>,</span><br><span class="line">		stateNode: <span class="literal">null</span>,</span><br><span class="line">		<span class="keyword">return</span>: <span class="literal">null</span>,</span><br><span class="line">		child: <span class="literal">null</span>,</span><br><span class="line">		sibling: <span class="literal">null</span>,</span><br><span class="line">		index: <span class="number">0</span>,</span><br><span class="line">		ref: <span class="literal">null</span>,</span><br><span class="line">		pendingProps: <span class="literal">null</span>,</span><br><span class="line">		memoizedProps: <span class="literal">null</span>,</span><br><span class="line">		updateQueue: <span class="literal">null</span>,</span><br><span class="line">		memoizedState: <span class="literal">null</span>,</span><br><span class="line">		dependencied: <span class="literal">null</span>,</span><br><span class="line">		mode: <span class="number">0</span>,</span><br><span class="line">		effectTag: <span class="number">0</span>,</span><br><span class="line">		nextEffect: <span class="literal">null</span>,</span><br><span class="line">		firstEffect: <span class="literal">null</span>,</span><br><span class="line">		lastEffect: <span class="literal">null</span>,</span><br><span class="line">		expirationTime: <span class="number">0</span>,</span><br><span class="line">		childExpirationTime: <span class="number">0</span>,</span><br><span class="line">		alternate: <span class="literal">null</span>,</span><br><span class="line">		actualDuration: <span class="number">0</span>,</span><br><span class="line">		actualStartTime: <span class="number">-1</span>,</span><br><span class="line">		selfBaseDuration: <span class="number">0</span>,</span><br><span class="line">		treeBaseDuration: <span class="number">0</span>,</span><br><span class="line">		_debugID: <span class="number">1</span>,</span><br><span class="line">		_debugIsCurrentlyTiming: <span class="literal">false</span>,</span><br><span class="line">		_debugSource: <span class="literal">null</span>,</span><br><span class="line">		_debugOwner: <span class="literal">null</span>,</span><br><span class="line">		_debugNeedsRemount: <span class="literal">false</span>,</span><br><span class="line">		_debugHookTypes: <span class="literal">null</span>,</span><br><span class="line">		stateNode: <span class="built_in">Object</span> current <span class="comment">// 循环引用current本身</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>所以<code>legacyCreateRootFromDOMContainer</code>最后会返回这样一个对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">	_internalRoot: root <span class="comment">// 见第8步</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="updateContainer"><a href="#updateContainer" class="headerlink" title="updateContainer"></a>updateContainer</h3><ol>
<li><p>即执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">updateContainer(</span><br><span class="line">	&#123;</span><br><span class="line">		$$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>.for(<span class="string">'react.element'</span>),</span><br><span class="line">		type: <span class="string">'h1'</span>,</span><br><span class="line">		key: <span class="literal">null</span>,</span><br><span class="line">		ref: <span class="literal">null</span>,</span><br><span class="line">		props: &#123;<span class="attr">children</span>: <span class="string">'Hello world'</span>&#125;,</span><br><span class="line">		_owner: Fiber,</span><br><span class="line">	&#125;,</span><br><span class="line">	fiberRoot, <span class="comment">// legacyCreateRootFromDOMContainer执行结果的root</span></span><br><span class="line">	<span class="literal">null</span>,</span><br><span class="line">	<span class="literal">undefined</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>整理一下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params">element, container, parentComponent, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> current$$<span class="number">1</span> = container.current; <span class="comment">// 就是fiberRoot的current</span></span><br><span class="line">  <span class="keyword">var</span> currentTime = requestCurrentTime(); <span class="comment">// 当前时间，todo：怎么生成的</span></span><br><span class="line">  <span class="keyword">var</span> suspenseConfig = requestCurrentSuspenseConfig(); <span class="comment">// todo：这是什么的配置</span></span><br><span class="line">  <span class="keyword">var</span> expirationTime = computeExpirationForFiber(currentTime, current$$<span class="number">1</span>, suspenseConfig); <span class="comment">// 终结时间 todo：怎么生成的</span></span><br><span class="line">  <span class="keyword">return</span> updateContainerAtExpirationTime(element, container, parentComponent, expirationTime, suspenseConfig, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="updateContainerAtExpirationTime"><a href="#updateContainerAtExpirationTime" class="headerlink" title="updateContainerAtExpirationTime"></a>updateContainerAtExpirationTime</h4><ol>
<li>整理如下<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateContainerAtExpirationTime</span>(<span class="params">element, container, parentComponent, expirationTime, suspenseConfig, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> If this is a nested container, this won't be the root.</span></span><br><span class="line">  <span class="keyword">var</span> current$$<span class="number">1</span> = container.current;</span><br><span class="line">	<span class="keyword">var</span> context = getContextForSubtree(parentComponent);</span><br><span class="line">  container.context = context;</span><br><span class="line">  <span class="keyword">return</span> scheduleRootUpdate(current$$<span class="number">1</span>, element, expirationTime, suspenseConfig, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="getContextForSubtree"><a href="#getContextForSubtree" class="headerlink" title="getContextForSubtree"></a>getContextForSubtree</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getContextForSubtree</span>(<span class="params">parentComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> emptyContextObject; <span class="comment">// &#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="scheduleRootUpdate"><a href="#scheduleRootUpdate" class="headerlink" title="scheduleRootUpdate"></a>scheduleRootUpdate</h4><ol>
<li><p>即执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scheduleRootUpdate(fiberRoot.current, &#123;</span><br><span class="line">		$$<span class="keyword">typeof</span>: <span class="built_in">Symbol</span>.for(<span class="string">'react.element'</span>),</span><br><span class="line">		type: <span class="string">'h1'</span>,</span><br><span class="line">		key: <span class="literal">null</span>,</span><br><span class="line">		ref: <span class="literal">null</span>,</span><br><span class="line">		props: &#123;<span class="attr">children</span>: <span class="string">'Hello world'</span>&#125;,</span><br><span class="line">		_owner: Fiber,</span><br><span class="line">	&#125;, expirationTime, suspenseConfig, <span class="literal">undefined</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>整理如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleRootUpdate</span>(<span class="params">current$$<span class="number">1</span>, element, expirationTime, suspenseConfig, callback</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> update = createUpdate(expirationTime, suspenseConfig);</span><br><span class="line">	</span><br><span class="line">  update.payload = &#123;</span><br><span class="line">    element: element</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  enqueueUpdate(current$$<span class="number">1</span>, update); <span class="comment">// 这个应该就是把需要更新的内容放到更新队列中去</span></span><br><span class="line">  scheduleWork(current$$<span class="number">1</span>, expirationTime); <span class="comment">// 这一步应该就是在终止时间之前更新</span></span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="unbatchedUpdates"><a href="#unbatchedUpdates" class="headerlink" title="unbatchedUpdates"></a>unbatchedUpdates</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unbatchedUpdates</span>(<span class="params">fn, a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext &amp;= ~BatchedContext;</span><br><span class="line">  executionContext |= LegacyUnbatchedContext;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fn(a);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (executionContext === NoContext) &#123;</span><br><span class="line">      <span class="comment">// Flush the immediate callbacks that were scheduled during this batch</span></span><br><span class="line">      flushSyncCallbackQueue();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getPublicRootInstance"><a href="#getPublicRootInstance" class="headerlink" title="getPublicRootInstance"></a>getPublicRootInstance</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPublicRootInstance</span>(<span class="params">container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> containerFiber = container.current;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (containerFiber.child.tag) &#123; <span class="comment">// 5</span></span><br><span class="line">		<span class="keyword">case</span> HostComponent: <span class="comment">// 5</span></span><br><span class="line">			<span class="comment">// stateNode就是真实的dom节点，react对它进行了一些修改</span></span><br><span class="line">      <span class="keyword">return</span> getPublicInstance(containerFiber.child.stateNode); <span class="comment">// return containerFiber.child.stateNode</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> containerFiber.child.stateNode;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="回顾-1"><a href="#回顾-1" class="headerlink" title="回顾"></a>回顾</h2><ol>
<li>至此，我们走完了整个流程。但是，<code>react</code>是如何将<code>jsx</code>更新到真实的<code>dom</code>节点上，还是很模糊，我们单独拎出来。</li>
<li>这段是关键：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">	updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ol>

  <div class="guide-links">
    
    
      <span>← <a href="/v2/frame/react/1_intro.html">介绍</a></span>
    
    
    
  </div>
  <div class="footer">
    发现错误？想参与编辑？
    <a href="https://github.com/mallow-fight/blog/tree/master/source/v2/frame/react/2_simple-use.md" target="_blank">
      在 GitHub 上编辑此页！
    </a>
    
    <span>更新于：2019-09-30 17:09:40</span>
  </div>
</div>


<!-- <div id="disqus_thread"></div>
<script>
  // it seems slowly page, so i annotation it.
  // disqus评论系统
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://mallow-fight.github.io/';  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = 'https://mallow-fight.github.io/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://mallow-blog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> -->
    </div>
    <script src="/js/smooth-scroll.min.js"></script>
  
  <!-- main custom script for sidebars, version selects etc. -->
  <script src="/js/css.escape.js"></script>
  <script src="/js/common.js"></script>
  <!-- search -->
  <link href="//cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/search.css">
  <script src="/js/docsearch.js"></script>
  <script>
  [
    '#search-query-nav',
    '#search-query-sidebar',
    '#search-query-menu'
  ].forEach(function (selector) {
    if (!document.querySelector(selector)) return
    docsearch({
      appId: 'FKZQZEMOI4',
      apiKey: '82fdcfac2e888595cb2807aa60aaad58',
      indexName: 'prod_blog',
      inputSelector: selector
    })
  })
  </script>
  <!-- fastclick -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
</body>
</html>